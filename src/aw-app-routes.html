<link rel="import" href="../bower_components/polymer/polymer-element.html"></link>

<link rel="import" href="../bower_components/app-route/app-location.html"></link>
<link rel="import" href="../bower_components/app-route/app-route.html"></link>

<link rel="import" href="pages/country/aw-country-routes.html">

<dom-module id="aw-app-routes">
  <template>
    <app-location route="{{_route}}"></app-location>
    <app-route
      pattern="[[_pattern]]"
      route="{{_route}}"
      tail="{{_subroute}}"
      data="{{_routeData}}"></app-route>
    <aw-country-routes route="{{_subroute}}" routes="{{_countryRoutes}}">
    </aw-country-routes>
  </template>
  <script>
    (() => {
      const routesData = [{
        name: 'home',
        title: 'Home',
        path: '/',
        subItems: null
      },
      {
        name: 'country',
        title: 'Country',
        path: '/country',
        subItems: null
      },
      {
        name: 'general',
        title: 'General',
        path: '/general',
        subItems: null
      }];

      class AwAppRoutes extends Polymer.Element {
        static get is() { return "aw-app-routes"; }

        static get properties() {
          return {
            routes: {
              type: Array,
              value: () => routesData.slice(),
              notify: true
            },
            page: {
              type: String,
              notify: true
            },
            rootPath: String,
            _pattern: String,
            _route: Object,
            _subroute: Object,
            _routeData: Object,
            _countryRoutes: Array
          };
        }

        static get observers() {
          return [
            '_update("routes.1.subItems", _countryRoutes.*)',
            '_routeDataChanged(_routeData.page)'
          ]
        }

        constructor () {
          super();

          this._pattern = `${(new URL(this.rootPath)).pathname}:page`;
        }

        _routeDataChanged(name) {
          if (name === undefined)
          {
            return;
          }

          this.page = this.routes.find(route => route.name === (name || 'home'));
        }

        _update(dataPath, changeRecord) {
          const { path, base, value } = changeRecord;
          if (path.indexOf('.') === -1)
          {
            this.set(dataPath, base);
            return;
          }

          const subPath = path.replace(/^.+\./, '');
          this.set(`${dataPath}.${subPath}`, value);
        }
      }
      window.customElements.define(AwAppRoutes.is, AwAppRoutes);
    })();
  </script>
</dom-module>