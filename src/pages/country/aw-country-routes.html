<link rel="import" href="../../../bower_components/polymer/polymer-element.html"></link>

<link rel="import" href="../../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html"></link>
<link rel="import" href="../../../bower_components/app-route/app-route.html"></link>

<link rel="import" href="../../../bower_components/polymerfire/firebase-auth.html"></link>
<link rel="import" href="../../../bower_components/polymerfire/firebase-document.html"></link>


<dom-module id="aw-country-routes">
  <template>
    <app-route
      pattern="/:country"
      route="{{route}}"
      data="{{_routeData}}"></app-route>

    <firebase-auth
      app-name="actiwiki"
      user="{{_user}}"
    ></firebase-auth>

    <firebase-document
      app-name="actiwiki"
      path="users/[[_user.uid]]/countries"
      data="{{_liveCountries}}"
    ></firebase-document>

    <app-indexeddb-mirror
      key="user/countries"
      data="{{_liveCountries}}"
      persisted-data="{{_countries}}"></app-indexeddb-mirror>
  </template>
  <script>
    (() => {
      const countrySubItems = [{
        name: "news",
        title: "News",
        basePath: "/news"
      }, {
        name: "legal",
        title: "Legal",
        basePath: "/legal"
      }, {
        name: "technologies",
        title: "Technologies",
        basePath: "/technology"
      }];

      class AwCountryRoutes extends Polymer.Element {
        static get is() { return "aw-country-routes"; }

        static get properties() {
          return {
            prefix: {
              type: String,
              value: ''
            },
            route: Object,
            routes: {
              type: Array,
              notify: true,
              computed: '_buildRoutes(prefix, _countries.*)'
            },
            _routeData: Object,
            _user: Object,
            _liveCountries: Object,
            _countries: Object
          };
        }

        _buildRoutes(prefix, changeRecord) {
          const keys = Object.keys(changeRecord.base || {});

          if (!keys.length) {
            return [];
          }

          return keys.reduce((routes, key) => [...routes, this._buildCountryRoute(prefix, key)], []);
        }

        _buildCountryRoute(prefix, country) {
          const path = `${prefix}/${country}`;
          return {
            name: country,
            basePath: '',
            path,
            title: country,
            subItems: this._buildSubItems(path, country).slice()
          };
        }

        _buildSubItems(prefix) {
          return countrySubItems.map(item => Object.assign(item, {
            path: `${prefix}${item.basePath}`
          }))
        }
      }
      window.customElements.define(AwCountryRoutes.is, AwCountryRoutes);
    })();
  </script>
</dom-module>